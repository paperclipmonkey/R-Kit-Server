<!DOCTYPE html><html lang="en"><head><title>authenticate</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="authenticate"><meta name="groc-project-path" content="authenticate.js"><meta name="groc-github-url" content="https://github.com/paperclipmonkey/R-Kit-Server"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paperclipmonkey/R-Kit-Server/blob/master/authenticate.js">authenticate.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>) <span class="hljs-comment">// Authentication</span>
  <span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>)
  <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  <span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)
  <span class="hljs-keyword">var</span> LocalStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy

  <span class="hljs-keyword">var</span> modelFiles = fs.readdirSync(__dirname + <span class="hljs-string">'/models/'</span>)
  modelFiles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) </span>{
    <span class="hljs-built_in">require</span>(__dirname + <span class="hljs-string">'/models/'</span> + file)
  })

  <span class="hljs-keyword">var</span> userModel = mongoose.model(<span class="hljs-string">'user'</span>)

  passport.use(<span class="hljs-keyword">new</span> LocalStrategy(
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">email, password, done</span>) </span>{
      <span class="hljs-keyword">var</span> shasum = crypto.createHash(<span class="hljs-string">'sha1'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Need to find user object to grab salt</p></div></div><div class="code"><div class="wrapper">      userModel.findOne({email: email}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user1</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done() <span class="hljs-comment">// done(err)</span>
        }
        <span class="hljs-keyword">if</span> (!user1) {
          <span class="hljs-keyword">return</span> done() <span class="hljs-comment">// done(new Error("Not found"))</span>
        }
        shasum.update(user1.salt + <span class="hljs-string">'&gt;&gt;&lt;&lt;'</span> + password) <span class="hljs-comment">// Salt + &gt;&gt;&lt;&lt; + pw = salting</span>
        <span class="hljs-keyword">var</span> toQuery = {
          <span class="hljs-string">'email'</span>: email,
          <span class="hljs-string">'password'</span>: shasum.digest(<span class="hljs-string">'hex'</span>)
        }
        userModel.findOne(toQuery, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user2</span>) </span>{
          <span class="hljs-keyword">if</span> (user2) {
            user2.lastLogin = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() <span class="hljs-comment">// Update last logged in time</span>
            user2.save()
          }
          done(err, user2)
        })
      })
    }
  ))

  passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, done</span>) </span>{
    done(<span class="hljs-literal">null</span>, user[<span class="hljs-string">'_id'</span>])
  })

  passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, done</span>) </span>{
    userModel.findOne({<span class="hljs-string">'_id'</span>: id}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      done(err, user)
    })
  })

  <span class="hljs-keyword">return</span> passport
})()</div></div></div></div></body></html>