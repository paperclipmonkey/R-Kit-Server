<!DOCTYPE html><html lang="en"><head><title>app</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="app"><meta name="groc-project-path" content="app.js"><meta name="groc-github-url" content="https://github.com/paperclipmonkey/R-Kit-Server"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paperclipmonkey/R-Kit-Server/blob/master/app.js">app.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="app">App</h1>
<h3 id="wire-the-application-together">Wire the application together</h3></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inlclude necessary packages</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>)
  <span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
  <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  <span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>)
  <span class="hljs-keyword">var</span> multipart = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-multiparty'</span>)()
  <span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>)
  <span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-session'</span>)
  <span class="hljs-keyword">var</span> methodOverride = <span class="hljs-built_in">require</span>(<span class="hljs-string">'method-override'</span>)
  <span class="hljs-keyword">var</span> errorHandler = <span class="hljs-built_in">require</span>(<span class="hljs-string">'errorhandler'</span>)
  <span class="hljs-keyword">var</span> pass = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./authenticate'</span>)
  <span class="hljs-keyword">var</span> hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>)
  <span class="hljs-keyword">var</span> middleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/middleware'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Include route files</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> routes = {
    authenticate: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/authenticate'</span>)(app),
    dashboard: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/dashboard'</span>)(app),
    download: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/download'</span>)(app),
    users: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/users'</span>)(app),
    responses: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes/responses'</span>)(app)
  }

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Using database '</span> + process.env.MONGO_URI)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Connect to the Database</p></div></div><div class="code"><div class="wrapper">  mongoose.connect(process.env.MONGO_URI)

  <span class="hljs-keyword">var</span> app = express()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Trust proxies. Useful when running on a platform like Heroku</p></div></div><div class="code"><div class="wrapper">  app.enable(<span class="hljs-string">'trust proxy'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Limiting size of upload to 100mb for speed and memory issues. Feel free to increase this</p></div></div><div class="code"><div class="wrapper">  app.use(methodOverride())
  app.use(bodyParser({
    limit: <span class="hljs-string">'100mb'</span>
  }))
  app.use(cookieParser())</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remember to change the session keys for your implementation</p></div></div><div class="code"><div class="wrapper">  app.use(session({
    keys: [<span class="hljs-string">'SomethingHereForSession'</span>, <span class="hljs-string">'SomethingElseHereForSession'</span>]
  }))
  app.use(pass.initialize())
  app.use(pass.session())
  app.use(express[<span class="hljs-string">'static'</span>](__dirname + <span class="hljs-string">'/public'</span>))
  app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'html'</span>)
  app.engine(<span class="hljs-string">'html'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>).__express)
  app.set(<span class="hljs-string">'views'</span>, __dirname)
  app.use(errorHandler({
    dumpExceptions: <span class="hljs-literal">true</span>,
    showStack: <span class="hljs-literal">true</span>
  }))

  <span class="hljs-comment">//Partials are reusable page elements</span>
  hbs.registerPartial(<span class="hljs-string">'head'</span>, fs.readFileSync(__dirname + <span class="hljs-string">'/views/partials/head.html'</span>, <span class="hljs-string">'utf8'</span>))
  hbs.registerPartial(<span class="hljs-string">'menuside'</span>, fs.readFileSync(__dirname + <span class="hljs-string">'/views/partials/menuside.html'</span>, <span class="hljs-string">'utf8'</span>))
  hbs.registerPartial(<span class="hljs-string">'script'</span>, fs.readFileSync(__dirname + <span class="hljs-string">'/views/partials/script.html'</span>, <span class="hljs-string">'utf8'</span>))

  hbs.registerHelper(<span class="hljs-string">'toJSON'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(obj)
  })

  hbs.registerHelper(<span class="hljs-string">'versionNo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> packageJSON = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./package.json'</span>)
    <span class="hljs-keyword">return</span> packageJSON.version
  })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="wire-up-the-urls-to-middleware-and-routes">Wire up the urls to middleware and routes</h3>
<p>Dashboard routes</p></div></div><div class="code"><div class="wrapper">  app.get(<span class="hljs-string">'/admin'</span>, middleware.ensureAuthenticated, routes.dashboard.dashboard)
  app.get(<span class="hljs-string">'/admin/dash/responses/week'</span>, middleware.ensureAuthenticated, routes.dashboard.dashboard_responses_week)
  app.get(<span class="hljs-string">'/admin/dash/responses/months'</span>, middleware.ensureAuthenticated, routes.dashboard.dashboard_responses_by_month)
  app.get(<span class="hljs-string">'/admin/dash/responses/total'</span>, middleware.ensureAuthenticated, routes.dashboard.dashboard_responses_total)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Download routes</p></div></div><div class="code"><div class="wrapper">  app.get(<span class="hljs-string">'/admin/responses/download/csv/:ids'</span>, middleware.ensureAuthenticated, routes.download.responses_download_csv)
  app.get(<span class="hljs-string">'/admin/responses/download/files/:ids'</span>, middleware.ensureAuthenticated, routes.download.responses_download_files)
  app.get(<span class="hljs-string">'/admin/responses/:id/download/file/:file'</span>, middleware.ensureAuthenticated, routes.download.response_download_file)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Response admin pages</p></div></div><div class="code"><div class="wrapper">  app.get(<span class="hljs-string">'/admin/responses'</span>, middleware.ensureAuthenticated, routes.responses.admin_list)
  app.get(<span class="hljs-string">'/admin/responses-datatables'</span>, middleware.ensureAuthenticated, routes.responses.datatables)
  app.get(<span class="hljs-string">'/admin/responses/:id'</span>, middleware.ensureAuthenticated, routes.responses.update)
  app.get(<span class="hljs-string">'/admin/responses/:id/delete'</span>, routes.responses.remove)
  app.post(<span class="hljs-string">'/admin/responses/:id'</span>, middleware.ensureAuthenticated, routes.responses.update)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>User admin pages</p></div></div><div class="code"><div class="wrapper">  app.get(<span class="hljs-string">'/admin/users'</span>, routes.users.users_list)
  app.get(<span class="hljs-string">'/admin/users/:id'</span>, middleware.ensureAuthenticated, routes.users.users_edit)
  app.post(<span class="hljs-string">'/admin/users/:id'</span>, middleware.ensureAuthenticated, multipart, routes.users.users_edit)
  app.get(<span class="hljs-string">'/admin/users/:id/delete'</span>, middleware.ensureAuthenticated, routes.users.users_delete)

  app.post(<span class="hljs-string">'/response'</span>, middleware.check_nonce, multipart, middleware.saveUploadedFiles, routes.responses.create)

  app.get(<span class="hljs-string">'/admin/login'</span>, routes.authenticate.login)
  app.get(<span class="hljs-string">'/admin/logout'</span>, routes.authenticate.logout)

  app.post(<span class="hljs-string">'/admin/login'</span>,
    pass.authenticate(
      <span class="hljs-string">'local'</span>, {
        failureRedirect: <span class="hljs-string">'/admin/login'</span>,
        failureFlash: <span class="hljs-literal">true</span>
      }),
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
      res.redirect(<span class="hljs-string">'/admin/'</span>) <span class="hljs-comment">// Authentication successful. Redirect home.</span>
    }
  )</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Error handling</p></div></div><div class="code"><div class="wrapper">  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, req, res, next</span>) </span>{
    <span class="hljs-comment">//console.log(err)</span>
    <span class="hljs-keyword">if</span> (!err) <span class="hljs-keyword">return</span> next()
    <span class="hljs-keyword">if</span> (!res.headersSent) {
      res.sendStatus(<span class="hljs-number">400</span>)
    }
  })

  <span class="hljs-keyword">return</span> app
})()</div></div></div></div></body></html>