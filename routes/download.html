<!DOCTYPE html><html lang="en"><head><title>routes/download</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/download"><meta name="groc-project-path" content="routes/download.js"><meta name="groc-github-url" content="https://github.com/paperclipmonkey/R-Kit-Server"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paperclipmonkey/R-Kit-Server/blob/master/routes/download.js">routes/download.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>)
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> archiver = <span class="hljs-built_in">require</span>(<span class="hljs-string">'archiver'</span>)
<span class="hljs-keyword">var</span> json2csv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'json2csv'</span>)
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>)
<span class="hljs-keyword">var</span> s3Client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../s3-client'</span>)

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="downloads-a-file-from-the-s3-data-service">Downloads a file from the S3 Data service</h2>
<p>Responds with a byte stream
Works with an evented system based on top of the Node.js Stream API</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">downloadFromS3</span> (<span class="hljs-params">filename</span>) </span>{
    <span class="hljs-keyword">var</span> s3Params = {
        Bucket: process.env.S3_BUCKET,
        Key: filename
        <span class="hljs-comment">//Key: 'example.jpg'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>other options supported by putObject, except Body and ContentLength.
See: <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObject-property">http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObject-property</a></p></div></div><div class="code"><div class="wrapper">    }
    <span class="hljs-keyword">var</span> downloader = s3Client.downloadStream(s3Params)
    downloader.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'unable to download from S3:'</span>, err.stack)
    })
    downloader.on(<span class="hljs-string">'progress'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-comment">//console.log("progress", downloader.progressMd5Amount,</span>
      <span class="hljs-comment">//downloader.progressAmount, downloader.progressTotal)</span>
    })
    downloader.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-comment">//console.log("done downloading from S3")</span>
    })
    <span class="hljs-keyword">return</span> downloader;
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="responses-downloaded-as-a-csv-file">Responses downloaded as a CSV file</h2>
<p>Without any file attachments</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> responses_download_csv = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> ids = req.params.ids
    ids = <span class="hljs-built_in">JSON</span>.parse(ids)
    download_docs(ids, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">docs</span>) </span>{
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (docs.length === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Empty result'</span>))
        }
        <span class="hljs-keyword">var</span> cDocs = []
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> doc <span class="hljs-keyword">in</span> docs) {
          cDocs.push(docs[doc].toCsv())
        }
        json2csv({data: cDocs, fields: [<span class="hljs-string">'id'</span>, <span class="hljs-string">'ts'</span>, <span class="hljs-string">'data'</span>, <span class="hljs-string">'files'</span>]}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">csv</span>) </span>{
          <span class="hljs-keyword">var</span> filename = <span class="hljs-string">'R-Kit.csv'</span>
          res.attachment(filename)
          res.end(csv)
        })
      } <span class="hljs-keyword">catch</span> (err) {
        next(err)
      }
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="download-all-documents-for-a-given-set-of-ids">Download all documents for a given set of IDs</h2>
<p>Responds with a zip file</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download_docs</span> (<span class="hljs-params">ids, done, res</span>) </span>{
    mongoose.model(<span class="hljs-string">'response'</span>).find({_id: {$<span class="hljs-keyword">in</span>: ids}}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, docs</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>next(err)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not find docs'</span>))
      }
      done(docs, res)
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="add-files-to-a-zip-file">Add files to a zip file</h2>
<p>Returns new zip file.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_files</span> (<span class="hljs-params">docs, zip</span>) </span>{
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> f = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> (i &lt; docs.length) {
      <span class="hljs-keyword">while</span> (f &lt; docs[i].files.length) {
        <span class="hljs-keyword">try</span> {
          zip.append(downloadFromS3(<span class="hljs-string">'uploads/'</span> + docs[i].file[f]), {name: docs[i].photo})
        } <span class="hljs-keyword">catch</span>(err) {
          <span class="hljs-built_in">console</span>.log(err)
        }
        f++
      }
      i++
    }
    <span class="hljs-keyword">return</span> zip
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="download-responses-as-a-zip-file">Download responses as a zip file</h2>
<p>Downloads files from S3 and zips them up
Returns file over HTTP</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> responses_download_files = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> ids = req.params.ids
    ids = <span class="hljs-built_in">JSON</span>.parse(ids)
    download_docs(ids, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">docs</span>) </span>{
      <span class="hljs-keyword">var</span> zip = archiver.create(<span class="hljs-string">'zip'</span>)
      res.attachment(<span class="hljs-string">'files.zip'</span>)
      zip.pipe(res)
      zip.addListener(<span class="hljs-string">'fail'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-built_in">console</span>.log(err)
      })

      add_files(docs, zip)
      zip.finalize()
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="download-single-file-from-s3">Download single file from S3</h2>
<p>Responds with file</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> response_download_file = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    mongoose.model(<span class="hljs-string">'response'</span>).findOne({_id: req.params.id}).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, doc</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-built_in">console</span>.log(err)
        <span class="hljs-keyword">return</span> next(err)
      }
      <span class="hljs-comment">//is file ID in there?</span>
      <span class="hljs-keyword">if</span>(doc.files[req.params.file]){
        res.setHeader(<span class="hljs-string">'Content-Disposition'</span>, <span class="hljs-string">'attachment; filename='</span> + doc.files[req.params.file])
        downloadFromS3(<span class="hljs-string">'uploads/'</span> + doc.files[req.params.file]).pipe(res)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'file doesn\'t exist'</span>))
      }
    })
  }

  <span class="hljs-keyword">return</span> {
    response_download_file: response_download_file,
    download_docs: download_docs,
    responses_download_csv: responses_download_csv,
    responses_download_files: responses_download_files,
  }
}</div></div></div></div></body></html>