<!DOCTYPE html><html lang="en"><head><title>routes/dashboard</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/dashboard"><meta name="groc-project-path" content="routes/dashboard.js"><meta name="groc-github-url" content="https://github.com/paperclipmonkey/R-Kit-Server"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paperclipmonkey/R-Kit-Server/blob/master/routes/dashboard.js">routes/dashboard.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="dashboard">Dashboard</h1>
<p>Functions and endpoints used on the dashboard page</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>)
<span class="hljs-keyword">var</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../common'</span>)

<span class="hljs-built_in">require</span>(<span class="hljs-string">'date-utils'</span>)

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="renders-the-dashboard-page">Renders the dashboard page</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> dashboard = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    res.render(<span class="hljs-string">'views/admin-dashboard.html'</span>, {
      user: req.user,
      pageDashboard: <span class="hljs-literal">true</span>
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="responses-by-month">Responses by month</h2>
<p>Responds in JSON with number per month.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> dashboard_responses_by_month = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> cback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Views by Month Error'</span>, err))
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Format we want to send data in
    {
    result: [
      {
        &quot;month&quot;: &quot;Jan&quot;,
        value: 5
      }
    ]
  }</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">var</span> altFormat = {}
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = results.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        altFormat[results[i]._id] = {
          value: results[i].usage[<span class="hljs-number">0</span>].count
        }
      }

      <span class="hljs-keyword">var</span> monthsAgo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">12</span>; i++) { <span class="hljs-comment">// Add in the additional months and data</span>
        <span class="hljs-keyword">var</span> name = monthsAgo.getMonth() + <span class="hljs-number">1</span> + <span class="hljs-string">''</span>

        <span class="hljs-keyword">if</span> (!altFormat[name]) {
          altFormat[name] = {value: <span class="hljs-number">0</span>}
        }

        altFormat[name].name = monthsAgo.getMonthAbbr() <span class="hljs-comment">// Append to object date name</span>
        monthsAgo.setMonth(monthsAgo.getMonth() - <span class="hljs-number">1</span>)
      }

      res.json({<span class="hljs-string">'result'</span>: altFormat})
    }

    <span class="hljs-keyword">var</span> doQuery = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">filter</span>) </span>{
      mongoose.model(<span class="hljs-string">'response'</span>).aggregate(
        filter,
        {
          $group: {
            _id: {month: {$month: <span class="hljs-string">'$ts'</span>}},
            count: {$sum: <span class="hljs-number">1</span>}
          }
        },
        {
          $group: {
            _id: <span class="hljs-string">'$_id.month'</span>,
            usage: {$push: {count: <span class="hljs-string">'$count'</span>}}
          }
        },
        cback
      )
    }

    <span class="hljs-keyword">var</span> monthsAgo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    monthsAgo.setMonth(monthsAgo.getMonth() - <span class="hljs-number">12</span>)
    <span class="hljs-keyword">var</span> filterQ = {
      $match: {
        <span class="hljs-string">'ts'</span>: {<span class="hljs-string">'$gte'</span>: monthsAgo}
      }
    }

    doQuery(filterQ)
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="responses-total-count">Responses total count</h2>
<p>Responds with an integer</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> dashboard_responses_total = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> cback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Dashboard Views Total Error'</span>, err))
      }
      res.json({<span class="hljs-string">'result'</span>: results})
    }
    mongoose.model(<span class="hljs-string">'response'</span>).count({}, cback)
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="responses-in-the-last-week">Responses in the last week</h2>
<p>Responds with an integer</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> dashboard_responses_week = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> cback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Dashboard Views Week Error'</span>, err))
      }
      res.json({<span class="hljs-string">'result'</span>: results})
    }

    <span class="hljs-keyword">var</span> weekAgo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
    weekAgo.setDate(weekAgo.getDate() - <span class="hljs-number">7</span>)

    mongoose.model(<span class="hljs-string">'response'</span>).count({<span class="hljs-string">'ts'</span>: {<span class="hljs-string">'$gte'</span>: weekAgo}}, cback)    
  }

  <span class="hljs-keyword">return</span> {
    dashboard: dashboard,
    dashboard_responses_by_month: dashboard_responses_by_month,
    dashboard_responses_total: dashboard_responses_total,
    dashboard_responses_week: dashboard_responses_week
  }

}</div></div></div></div></body></html>