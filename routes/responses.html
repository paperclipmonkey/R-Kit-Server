<!DOCTYPE html><html lang="en"><head><title>routes/responses</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/responses"><meta name="groc-project-path" content="routes/responses.js"><meta name="groc-github-url" content="https://github.com/paperclipmonkey/R-Kit-Server"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paperclipmonkey/R-Kit-Server/blob/master/routes/responses.js">routes/responses.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="responses">responses</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>)
<span class="hljs-keyword">var</span> <span class="hljs-built_in">escape</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'escape-html'</span>)
<span class="hljs-keyword">var</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../common'</span>)
<span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="new-response">New response</h2>
<p>Save uploaded response to the Database</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> toInsert = req.body

    toInsert.files = req.uploadedFiles

    <span class="hljs-keyword">var</span> FeedbackModel = mongoose.model(<span class="hljs-string">'response'</span>)
    <span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">new</span> FeedbackModel(toInsert)
    instance.save(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        res.status(<span class="hljs-number">400</span>).json(<span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-string">'err'</span>: err.message}))
        <span class="hljs-keyword">return</span> res.end()
      }

      <span class="hljs-comment">//common.emailAdmins(instance)</span>

      res.json(instance.toClient()) <span class="hljs-comment">// JSON</span>
      res.end()
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="list">List</h2>
<p>Render the view for the user</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> admin_list = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    res.render(<span class="hljs-string">'views/admin-responses.html'</span>, {
      user: req.user,
      pageResponses: <span class="hljs-literal">true</span>
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="list-data">List (Data)</h2>
<p>List the responses in a JSON format edible by the frontend</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> datatables = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO Grab all areas associated with the user
TODO - Use new function to get all geo polygons</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> cback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> next(err)
      }
      <span class="hljs-keyword">var</span> snd = []
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = results.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        <span class="hljs-keyword">var</span> cur = results[i]
        snd.push([cur._id, cur.ts, cur.data, cur.files])
      }
      res.json({<span class="hljs-string">'aaData'</span>: snd})
    }

    mongoose.model(<span class="hljs-string">'response'</span>).find({}, cback)
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="delete">Delete</h2>
<p>Remove a response from the database.
Doesn&#39;t remove uploaded files as well</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> remove = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
    mongoose.model(<span class="hljs-string">'response'</span>).findByIdAndRemove(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, doc</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> next(err)
      res.redirect(<span class="hljs-string">'/admin/responses'</span>)
    })
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="update">Update</h2>
<p>Update a response in the database</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> update = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO - remove async</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">async</span>.parallel({
      response: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
        <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'POST'</span>) {
          mongoose.model(<span class="hljs-string">'response'</span>).findOneAndUpdate({_id: req.params.id}, req.body, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, doc</span>) </span>{
            callback(err, doc)
          })
        } <span class="hljs-keyword">else</span> {
          mongoose.model(<span class="hljs-string">'response'</span>).findOne({_id: req.params.id}).exec(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, docs</span>) </span>{
            callback(err, docs)
          })
        }
      }
    },
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> next(err)
        }
        res.render(<span class="hljs-string">'views/admin-response.html'</span>, {
          user: req.user,
          static_url: process.env.S3_URL,
          responseedit: results.response,
          pageResponses: <span class="hljs-literal">true</span>
        })
      })
  }

  <span class="hljs-keyword">return</span> {
    create: create,
    admin_list: admin_list,
    datatables: datatables,
    remove: remove,
    update: update
  }
}</div></div></div></div></body></html>