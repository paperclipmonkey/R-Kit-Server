<!DOCTYPE html><html lang="en"><head><title>models/User</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="models/User"><meta name="groc-project-path" content="models/User.js"><meta name="groc-github-url" content="https://github.com/paperclipmonkey/R-Kit-Server"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paperclipmonkey/R-Kit-Server/blob/master/models/User.js">models/User.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="user-model">User model</h1>
<p>Used to store an admin user model for use logging in and out of the admin panel</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>)
<span class="hljs-keyword">var</span> Schema = mongoose.Schema
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)
<span class="hljs-keyword">var</span> emailRegex = <span class="hljs-regexp">/^([\w\!\#$\%\&amp;\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*[\w\!\#$\%\&amp;\'\*\+\-\/\=\?\^\`{\|\}\~]+@((((([a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,6})|(\d{1,3}\.){3}\d{1,3}(\:\d{1,5})?)$/i</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="the-model">The model</h2>
<p>The fields created are:</p>
<p><strong>email</strong> - Login email address for the user</p>
<p><strong>password</strong> - SHA1 encrypted password</p>
<p><strong>salt</strong> - Salt appended to the PW before encrypting</p>
<p><strong>fullname</strong> - The full name of the user</p>
<p><strong>phoneno</strong> - The phone number of the user</p>
<p><strong>emailOnResponse</strong> - Email the user when a new response is received</p>
<p><strong>lastLogin</strong> - A timestamp of when the user last visited an admin page</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
  <span class="hljs-keyword">var</span> UserSchema = <span class="hljs-keyword">new</span> Schema({
    email: {type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span>, unique: <span class="hljs-literal">true</span>, match: emailRegex},
    password: {type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span>},
    salt: {type: <span class="hljs-built_in">String</span>},
    fullname: {type: <span class="hljs-built_in">String</span>},
    phoneno: {type: <span class="hljs-built_in">String</span>},
    emailOnResponse: {type: <span class="hljs-built_in">Boolean</span>, <span class="hljs-keyword">default</span>: <span class="hljs-literal">false</span>, required: <span class="hljs-literal">true</span>},
    lastLogin: {type: <span class="hljs-built_in">Date</span>, required: <span class="hljs-literal">true</span>, <span class="hljs-keyword">default</span>: <span class="hljs-built_in">Date</span>.now}
  })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="before-save">Before save</h2>
<p>Check if the password has changed.</p></div></div><div class="code"><div class="wrapper">  UserSchema.pre(<span class="hljs-string">'save'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
    <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">if</span> (!user.salt) {
      user.salt = user.email <span class="hljs-comment">// Set it up as email on first usage</span>
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>only hash the password if it has been modified (or is new)</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (!user.isModified(<span class="hljs-string">'password'</span>)) {
      <span class="hljs-keyword">return</span> next()
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hash the Password</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> shasum = crypto.createHash(<span class="hljs-string">'sha1'</span>)
    shasum.update(user.salt + <span class="hljs-string">'&gt;&gt;&lt;&lt;'</span> + user.password) <span class="hljs-comment">// Email + &gt;&gt;&lt;&lt; + pw = salting</span>
    user.password = shasum.digest(<span class="hljs-string">'hex'</span>)
    next()
  })
  <span class="hljs-keyword">return</span> mongoose.model(<span class="hljs-string">'user'</span>, UserSchema)
})()</div></div></div></div></body></html>